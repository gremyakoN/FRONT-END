<ng-container *ngIf="states.initComplete.value">
    <form login [class.visible]="!states.loggedIn.value">
        <mat-card>
            <div logo mat-card-image><img src="assets/svg/logo.svg"/></div>
            <mat-form-field appearance="outline">
                <mat-label>{{states.texts.value.forms.username.placeholder[states.lang.value]}}</mat-label>
                <input matInput [formControl]="usernameFormControl" (input)="hideLoginError()"/>
                <mat-error *ngIf="usernameFormControl.hasError('required')">
                    <text-label id="forms.username.required"></text-label>
                </mat-error>
            </mat-form-field>
            <mat-form-field appearance="outline">
                <mat-label>{{states.texts.value.forms.password.placeholder[states.lang.value]}}</mat-label>
                <input matInput type="password" [formControl]="passwordFormControl" (input)="hideLoginError()"/>
                <mat-error *ngIf="passwordFormControl.hasError('required')">
                    <text-label id="forms.password.required"></text-label>
                </mat-error>
            </mat-form-field>
            <button sign-in mat-flat-button color="primary" (click)="login()">
                <text-label id="forms.signin"></text-label>
            </button>
            <text-label error [id]="states.loginError.value ? 'forms.error.' + states.loginError.value : ''"
                        [class.visible]="states.loginErrorVisible.value"></text-label>
            <button mat-button forgot-password (click)="forgotPassword()">
                <text-label id="forms.forgotPassword"></text-label>
            </button>
        </mat-card>
    </form>
    <div main [class.visible]="states.loggedIn.value">
        <div menu>
            <div top>
                <div logo>
                    <img logo src="assets/svg/logo.svg"/>
                </div>
                <mat-action-list menu-container>
                    <ng-container *ngFor="let menuItem of menuItems">
                        <ng-container *ngIf="menuItem != null">
                            <button mat-list-item [class.selected]="states.selectedMenu.value === menuItem"
                                    (click)="states.selectedMenu.set(menuItem)">
                                <text-label [id]="'menu.' + menuItem"></text-label>
                            </button>
                        </ng-container>
                        <ng-container *ngIf="menuItem == null">
                            <mat-divider></mat-divider>
                        </ng-container>
                    </ng-container>
                </mat-action-list>
            </div>
            <button compact-menu mat-button [matMenuTriggerFor]="menu">
                <mat-icon>menu</mat-icon>
                <text-label [id]="'menu.' + states.selectedMenu.value"></text-label>
                <mat-menu #menu="matMenu" class="top-menu">
                    <ng-container *ngFor="let menuItem of menuItems">
                        <ng-container *ngIf="menuItem != null">
                            <button mat-menu-item [class.selected]="states.selectedMenu.value === menuItem"
                                    (click)="states.selectedMenu.set(menuItem)">
                                <text-label [id]="'menu.' + menuItem"></text-label>
                            </button>
                        </ng-container>
                        <ng-container *ngIf="menuItem == null">
                            <mat-divider></mat-divider>
                        </ng-container>
                    </ng-container>
                </mat-menu>
            </button>
            <div logout *ngIf="states.user.value">
                <user-info></user-info>
                <button mat-icon-button [matMenuTriggerFor]="userMenu">
                    <mat-icon>person</mat-icon>
                    <mat-menu #userMenu="matMenu" class="user-menu">
                        <user-info></user-info>
                    </mat-menu>
                </button>
            </div>
        </div>
        <div content>
            <div members [class.inactive]="states.selectedMenu.value != 'members'">
                <mat-card>
                    <div top>
                        <mat-form-field search appearance="outline">
                            <mat-label>{{states.texts.value.members.search[states.lang.value]}}</mat-label>
                            <input #searchInput matInput type="search" (keyup)="updateSearchInputWithEnter($event)"/>
                            <button mat-button *ngIf="searchInput.value" matSuffix mat-icon-button
                                    (click)="updateSearchInput(''); searchInput.value = ''">
                                <mat-icon>close</mat-icon>
                            </button>
                        </mat-form-field>
                        <button search-submit mat-stroked-button (click)="updateSearchInput(searchInput.value)">
                            <mat-icon>search</mat-icon>
                        </button>
                        <button edit-filters mat-stroked-button [class.selected]="states.searchFiltersExpanded.value"
                                (click)="states.searchFiltersExpanded.set(!states.searchFiltersExpanded.value)">
                            <mat-icon>filter_list</mat-icon>
                        </button>
                    </div>
                    <search-filters></search-filters>
                </mat-card>
                <search-results [resultState]="states.searchResult" [paramsState]="states.searchParams" [searchingState]="states.searching"></search-results>
            </div>
            <div payments [class.inactive]="states.selectedMenu.value != 'payments'">
                <mat-card>
                    <div top>
                        <mat-form-field search appearance="outline">
                            <mat-label>{{states.texts.value.payments.search[states.lang.value]}}</mat-label>
                            <input #searchPaymentsInput matInput type="search"
                                   (keyup)="updateSearchPaymentsInputWithEnter($event)"/>
                            <button mat-button *ngIf="searchPaymentsInput.value" matSuffix mat-icon-button
                                    (click)="updateSearchPaymentsInput(''); searchPaymentsInput.value = ''">
                                <mat-icon>close</mat-icon>
                            </button>
                        </mat-form-field>
                        <button search-submit mat-stroked-button
                                (click)="updateSearchPaymentsInput(searchPaymentsInput.value)">
                            <mat-icon>search</mat-icon>
                        </button>
                        <button edit-filters mat-stroked-button
                                [class.selected]="states.searchPaymentsFiltersExpanded.value"
                                (click)="states.searchPaymentsFiltersExpanded.set(!states.searchPaymentsFiltersExpanded.value)">
                            <mat-icon>filter_list</mat-icon>
                        </button>
                    </div>
                    <search-payments-filters *ngIf="states.user.value"></search-payments-filters>
                </mat-card>
                <search-payments-results></search-payments-results>
            </div>
            <div events [class.inactive]="states.selectedMenu.value != 'events'">
                <div top-buttons buttons>
                    <mat-button-toggle-group #eventsCalendarRange="matButtonToggleGroup" value="Month"
                                             (change)="eventsCalendar.getApi().changeView(eventsCalendarType.value + eventsCalendarRange.value)">
                        <mat-button-toggle value="Month">
                            <mat-icon>view_module</mat-icon>
                            <!--<text-label id="events.month"></text-label>-->
                        </mat-button-toggle>
                        <mat-button-toggle value="Week">
                            <mat-icon>view_week</mat-icon>
                            <!--<text-label id="events.week"></text-label>-->
                        </mat-button-toggle>
                        <mat-button-toggle value="Day">
                            <mat-icon>view_day</mat-icon>
                            <!--<text-label id="events.day"></text-label>-->
                        </mat-button-toggle>
                    </mat-button-toggle-group>
                    <mat-button-toggle-group #eventsCalendarType="matButtonToggleGroup" value="dayGrid"
                                             (change)="eventsCalendar.getApi().changeView(eventsCalendarType.value + eventsCalendarRange.value)">
                        <mat-button-toggle value="dayGrid">
                            <mat-icon>calendar_today</mat-icon>
                        </mat-button-toggle>
                        <mat-button-toggle value="list">
                            <mat-icon>list</mat-icon>
                        </mat-button-toggle>
                    </mat-button-toggle-group>
                </div>
                <mat-card calendar>
                    <div header>
                        <div title>
                            {{states.eventsCalendarTitle.value}}
                        </div>
                        <div nav>
                            <button mat-icon-button (click)="eventsCalendar.getApi().prev()">
                                <mat-icon>arrow_back</mat-icon>
                            </button>
                            <button mat-icon-button (click)="eventsCalendar.getApi().today()">
                                <mat-icon>restore</mat-icon>
                            </button>
                            <button mat-icon-button (click)="eventsCalendar.getApi().next()">
                                <mat-icon>arrow_forward</mat-icon>
                            </button>
                        </div>
                    </div>
                    <div calendar-body>
                        <full-calendar *ngIf="states.events.value" defaultView="dayGridMonth"
                                       [header]="null"
                                       [plugins]="calendarPlugins"
                                       [events]="states.events.value"
                                       (eventClick)="addEvent($event.event.id)"
                                       [navLinkDayClick]="addEventWithDateBound"
                                       [handleWindowResize]="true"
                                       windowResizeDelay="0"
                                       height="parent"
                                       [editable]="false"
                                       [eventLimit]="true"
                                       locale="ru"
                                       [navLinks]="true"
                                       [noEventsMessage]="states.texts.value.events.noEvents[states.lang.value]">
                        </full-calendar>
                    </div>
                </mat-card>
                <div buttons>
                    <button mat-flat-button color="primary" (click)="addEvent()">
                        <mat-icon>add</mat-icon>
                        <text-label id="events.addEvent"></text-label>
                    </button>
                </div>
            </div>
            <div news [class.inactive]="states.selectedMenu.value != 'news'">
                <mat-card *ngFor="let article of states.news.value; let i = index">
                    <mat-card-header>
                        <mat-card-title>{{article.author}}</mat-card-title>
                        <mat-card-subtitle>{{utils.formatJavaDate(article.changed)}}</mat-card-subtitle>
                    </mat-card-header>
                    <mat-card-content>
                        <div title><h2>{{article.name}}</h2>
                            <button mat-icon-button *ngIf="article.link"
                                    (mouseover)="states.activeLinkPreview.set(i)"
                                    (mouseout)="states.activeLinkPreview.set(null)"
                                    (click)="utils.windowOpen((article.link.indexOf('http') === 0) ? article.link : 'http://' + article.link, '_blank')">
                                <mat-icon>link</mat-icon>
                                <link-preview [url]="(states.activeLinkPreview.value == i) ? article.link : null"></link-preview>
                            </button>
                        </div>
                        {{article.additional_info}}
                    </mat-card-content>
                    <mat-card-footer
                            *ngIf="states.user.value && ((states.user.value.hierarchy_level === 4) || article.editable)">
                        <button mat-icon-button (click)="addArticle(article)">
                            <mat-icon>edit</mat-icon>
                        </button>
                        <button mat-icon-button (click)="deleteArticle(article.id)">
                            <mat-icon>delete</mat-icon>
                        </button>
                    </mat-card-footer>
                </mat-card>
                <div buttons *ngIf="states.user.value && states.user.value.is_admin">
                    <button add-article mat-flat-button color="primary" (click)="addArticle()">
                        <mat-icon>add</mat-icon>
                        <text-label id="news.addArticle"></text-label>
                    </button>
                </div>
            </div>
            <div hierarchy [class.inactive]="states.selectedMenu.value != 'hierarchy'">
                <mat-card>
                    <mat-tree *ngIf="hierarchyDataSource.data" [dataSource]="hierarchyDataSource"
                              [treeControl]="hierarchyTreeControl" class="example-tree">
                        <mat-tree-node *matTreeNodeDef="let node" matTreeNodeToggle>
                            <li class="mat-tree-node">
                                <button mat-icon-button disabled></button>
                                <button mat-stroked-button (click)="showCommitteeDetails(node)">{{node.name}}</button>
                            </li>
                        </mat-tree-node>
                        <mat-nested-tree-node *matTreeNodeDef="let node; when: committeeHasChildrenBound">
                            <li>
                                <div class="mat-tree-node">
                                    <button mat-icon-button matTreeNodeToggle>
                                        <mat-icon class="mat-icon-rtl-mirror"
                                                  [class.expanded]="hierarchyTreeControl.isExpanded(node)">
                                            chevron_right
                                        </mat-icon>
                                    </button>
                                    <button mat-stroked-button
                                            (click)="showCommitteeDetails(node)">{{node.name}}</button>
                                </div>
                                <ul [class.hidden]="!hierarchyTreeControl.isExpanded(node)">
                                    <ng-container matTreeNodeOutlet></ng-container>
                                    <ng-container *ngIf="states.primaryOrganizationsByCommittee.value[node.id]">
                                        <li class="mat-tree-node"
                                            *ngFor="let po of states.primaryOrganizationsByCommittee.value[node.id]">
                                            <button mat-icon-button disabled></button>
                                            <button mat-stroked-button primary-organization
                                                    (click)="showPrimaryOrganizationDetails(po)">{{po.name}}</button>
                                        </li>
                                    </ng-container>
                                </ul>
                            </li>
                        </mat-nested-tree-node>
                    </mat-tree>
                </mat-card>
                <div buttons
                     *ngIf="states.user.value && (states.user.value.is_admin && ((states.user.value.hierarchy_level == 1) || (states.user.value.hierarchy_level > 2)))">
                    <button add-сommittee mat-flat-button color="primary" *ngIf="states.user.value.hierarchy_level > 2"
                            (click)="showCommitteeDetails()">
                        <mat-icon>add</mat-icon>
                        <text-label id="hierarchy.addCommittee"></text-label>
                    </button>
                    <button add-primary-organization
                            *ngIf="states.user.value && ((states.user.value.hierarchy_level == 1) || (states.user.value.hierarchy_level == 4))"
                            mat-flat-button color="primary" (click)="showPrimaryOrganizationDetails()">
                        <mat-icon>add</mat-icon>
                        <text-label id="hierarchy.addPrimaryOrganization"></text-label>
                    </button>
                </div>
            </div>
            <div assignments [class.inactive]="states.selectedMenu.value != 'assignments'">
                <ng-container *ngFor="let assignmentLevel of states.assignmentsLevels.value">
                    <mat-card *ngIf="states.assignmentsByLevel.value && states.assignmentsByLevel.value[assignmentLevel]">
                        <mat-card-header>
                            <mat-card-title>
                                <text-label title [id]="'assignments.' + assignmentLevel"></text-label>
                            </mat-card-title>
                        </mat-card-header>
                        <mat-card-content>
                            <button mat-stroked-button
                                    *ngFor="let assignment of states.assignmentsByLevel.value[assignmentLevel]"
                                    (click)="showAssignmentEdit(assignment)"
                                    [class.disabled]="!states.user.value || !((assignment.hierarchy_level <= states.user.value.hierarchy_level) && (states.user.value.hierarchy_level > 2))">
                                <div info>
                                    <div name [class.admin]="assignment.is_admin">{{assignment.name}}</div>
                                </div>
                                <ng-container
                                        *ngIf="states.user.value && (assignment.hierarchy_level <= states.user.value.hierarchy_level) && (states.user.value.hierarchy_level > 2)">
                                </ng-container>
                            </button>
                        </mat-card-content>
                    </mat-card>
                </ng-container>
                <div buttons
                     *ngIf="states.user.value && (states.user.value.is_admin && (states.user.value.hierarchy_level > 2))">
                    <button add-assignment mat-flat-button color="primary" (click)="showAssignmentEdit()">
                        <mat-icon>add</mat-icon>
                        <text-label id="assignments.addAssignment"></text-label>
                    </button>
                </div>
            </div>
            <div categories [class.inactive]="states.selectedMenu.value != 'categories'">
                <table-sort *ngIf="states.categories.value && states.categories.value.length"
                            [columns]="['name', 'amount']"
                            [dataState]="states.categories"
                            clickable="true"
                            (clicked)="showCategoryEdit($event)"
                            labelPrefix="categories"></table-sort>
                <div buttons
                     *ngIf="states.user.value && (states.user.value.is_admin && (states.user.value.hierarchy_level > 2))">
                    <button add-category mat-flat-button color="primary" (click)="showCategoryEdit()">
                        <mat-icon>add</mat-icon>
                        <text-label id="categories.addCategory"></text-label>
                    </button>
                </div>
            </div>
            <div promotions [class.inactive]="states.selectedMenu.value != 'promotions'">
                <table-sort *ngIf="states.promotions.value && states.promotions.value.length"
                            [columns]="['name', 'min_value', 'max_value']"
                            [dataState]="states.promotions"
                            clickable="true"
                            (clicked)="showPromotionEdit($event)"
                            labelPrefix="promotions"></table-sort>
                <div buttons
                     *ngIf="states.user.value && (states.user.value.is_admin && (states.user.value.hierarchy_level > 2))">
                    <button add-promotions mat-flat-button color="primary" (click)="showPromotionEdit()">
                        <mat-icon>add</mat-icon>
                        <text-label id="promotions.addPromotion"></text-label>
                    </button>
                </div>
            </div>
        </div>
    </div>
</ng-container>
<div curtain [class.visible]="states.curtainVisible.value">
    <mat-spinner></mat-spinner>
</div>
